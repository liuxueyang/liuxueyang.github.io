---
layout: post
title:  6.824 Lab2B
date:   2020-12-22 15:35:21 +0800
tags:   raft 6.824
---

6.824 Lab2B 做的過程中遇到了很多坑，我覺得把這些坑記錄下來比較有幫助。雖然現在這個實驗幾乎快做完了，很多遇到的坑也快忘記了，先開一個坑，以後慢慢補充吧。我覺得這個實驗做一遍是不夠的，以後再做第二遍。

Follower 超時之後，如果它立刻自增 Term 並且發起選舉，並且它的 Log 不如 majority 新，此時它一定會競選失敗，其實它浪費了其它 Server 的時間。假設有一個唯一有資格成爲 Leader 的 Server B 一直收到 Server A 的 RequestVote 請求，並且 Server A 的 Term 比較新，此時 B 需要重置自己的超時時間，這樣 B 的超時一直被 A 打斷。或者如果 B 超時了之後，在 A 接到 B 的 RequestVote 請求之前，A 也超時了，此時 A 會投票給自己，B 還是得不到 A 的選票。這兩種情況如果反覆發生，可能會導致 A 永遠也無法成爲 Leader，這個 cluster 可能在很長的時間內都選不出 Leader。

所以 Server 在超時之後，成爲 Candidate 之前，需要進行預選舉，確保自己的 Log 比 majority 都新。這樣就減少了其它 Server 超時被打斷的次數，讓有機會成爲 Leader 的 Server 更容易被選舉出來。

其實這中間有個問題需要考慮。爲什麼 Receiver 接收到 Term 更新的 RequestVote 的時候，需要重置超時時間呢？首先，更新 Receiver 的 Term 肯定是必須的。假設我們只更新了 Receiver 的 Term，但是沒有重置超時時間，會發生什麼呢？

### 如何實現 PreVote

1. 給 Server 添加一個 preCandidate 的狀態
2. 在 Follower 超時之後，Term 先不自增，發起預選舉
3. 復用 RequestVote 請求，添加預選舉標記
4. 如果請求是預選舉，需不需要更新 Receiver 的 Term 呢？不需要。目的是爲了儘量不打擾其它 Server
5. 如果 preCandidate 日誌比 receiver 新，返回真
6. 如果 preCandidate 獲得了 majority 選票，並且它的 Term 沒有改變，轉換成 Candidate，發起真正的選舉。
7. 如果 pre-vote 超時或者失敗了，那麼轉換成 Follower
